{% import 'blocks.html' as blocks %}
<!DOCTYPE html>
<html lang="en"><head><title>Schematic Editor - Galaxy Harvester</title>
<link rel="stylesheet" href="/style/ghCore.css" type="text/css" />
<link rel="stylesheet" href="/style/themes/{{ uiTheme }}.css" type="text/css" />
<script type="text/javascript" src="/js/ghShared.js"></script>
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/jquery-ui-1.8.20.custom.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
  $("#galaxySel").val(getCookie("galaxy",defaultGalaxy));
  refreshSkillGroups();
  $("#skillGroupSel").val({{ schematic.skillGroup }});
  $("#craftingTabSel").val({{ schematic.craftingTab }});
  $("#objectTypeSel").val({{ schematic.objectType }});
	loadIngredientPicker();
  $(".statSelector").each( function(i, obj) {
    $(obj).val($(obj).attr('tag'));
  });

  $(".window .close").click(function(e) {
		e.preventDefault();
		$("#mask, .window").hide();
	});
	$("#mask").click(function() {
		$(this).hide();
		$(".window").hide();
	});
});
function handleIngredientDrop(event, ui) {
  transmuteIngredient(ui.draggable);
}
function ingredientPickerItemClick() {
    inv = this;
    $("#ingredientPickerList").find("div.inventoryItem").css("border", "none");
    $("#ingredientPickerList").find("div.inventoryItem").css("margin", "4px");
    $(this).css("border", "1px solid");
    $(this).css("margin", "3px");
}
function ingredientPickerItemDoubleClick() {
    transmuteIngredient(this);
}
function transmuteIngredient(ingredientObject) {
  var objectName = $(ingredientObject).children('div').html();
  var objectID = $(ingredientObject).attr('id').substr(14);
  var imageName = $(ingredientObject).css('background-image').replace('url("', '').replace('")', '');

  addSchematicIngredient(objectID, objectName, imageName);
}
function addSchematicIngredient(objectID, objectName, imagePath) {
  // Add new ingredient row
  $('#ingredientTable').append('							<tr class="ingredientRow" tt="'+objectName+'">'+
                  '<td><img src="/images/xRed16.png" alt="Remove Ingredient" title="Remove Ingredient" style="cursor:pointer;" onclick="$(this).parent().parent().remove();"/></td>'+
                  '<td><input type="text" name="ing_name_new_'+objectID+'" value=""  /></td>'+
                  '<td style="padding-right:4px;"><input type="text" name="ing_qty_new_'+objectID+'" size="5" maxlength="7" value="" /></td>'+
                  '<td><img src="'+imagePath+'" class="schematicIngredient" /></td>'+
  						  '</tr>');
}
function loadIngredientPicker() {
    $("#busyImg").css("display","block");
    var ingredientService = "";
    if ($("#oResType").attr("checked") == "checked") {
      ingredientService = "getResourceTypeList.py";
      $("#tabSel").css("display","none");
      $("#resGroupSel").css("display","block");
      $("#resGroupShortSel").css("display","none");
    } else if ($("#oResGroup").attr("checked") == "checked") {
      ingredientService = "getResourceGroupList.py";
      $("#tabSel").css("display","none");
      $("#resGroupSel").css("display","none");
      $("#resGroupShortSel").css("display","block");
    } else {
      ingredientService = "getComponentList.py";
      $("#tabSel").css("display","block");
      $("#resGroupSel").css("display","none");
      $("#resGroupShortSel").css("display","none");
    }

    $("#ingredientPickerList").load(BASE_SCRIPT_URL + ingredientService,{
        galaxy: $("#galaxySel").val(),
        outType: "graphic",
        resCategory: $("#resGroupShortSel").val(),
        resGroup: $("#resGroupSel").val(),
        craftingTab: $("#tabSel").val()},
        function() {
            var ipl = $("#ingredientPickerList");
            ipl.find("div.inventoryItem").draggable({
                stack: ".inventoryItem",
                cursor: "grab",
                revert: "true",
                appendTo: "body",
                helper: "clone"}).click(ingredientPickerItemClick).dblclick(ingredientPickerItemDoubleClick);
            $("#schematicIngredients").droppable({
                drop: handleIngredientDrop,
                hoverClass: "control"
            });
            $("#busyImgList").css("display","none");
        });
    return false;
}
function slotHoverCheck(e) {
    var tt = $("#tooltip");
    var ri = $("#schematicIngredients").find(".ingredientRow");
    var cOffset = $("#schematicIngredients").offset();
    var cX = e.pageX - cOffset.left;
    var cY = e.pageY - cOffset.top;
    var found = false;
    for (i=0;i<ri.length;i++) {
        ing = $(ri.eq(i));
        wpX = ing.position().left;
        wpY = ing.position().top;
        if (cX > wpX && cX < (wpX + ing.width()) && cY > wpY && cY < (wpY + ing.height())) {
            if (ing.attr("tt") != undefined) {
                slotData = ing.attr("tt");
                tt.html(slotData);
                tt.css("left", e.pageX + 6);
                tt.css("top", e.pageY + 6);
                tt.show();
                found = true;
                break;
            }
        }
    }
    if (!found) {
        tt.hide();
    }
}
function refreshSkillGroups() {
	$("#skillGroupSel").load(BASE_SCRIPT_URL + "getSkillGroupList.py", { prof: $("#schemProfSel").val() })
}
</script>
{{ blocks.pageTracker() }}
<body>
{{ blocks.headerSection(loggedin, currentUser, loginResult, linkappend, url, imgNum, galaxyList, pictureName) }}
<div id="mainContent" class="wrapper">
  <div id="leftNavContent" class="ghCol">
    <div id="schemList" class="ghWidgetBox">
      <div class="boxHeader">Ingredient Selector
        <span style="float:right;font-weight:normal;font-size:.9em;"><a href="{{ BASE_SCRIPT_URL }}schematics.py/home" title="Go back to the schematics home page">[Home]</a></span>
		  </div>
      <div>View: <span style="font-weight:normal;">
        <input type="radio" name="oSelectType" id="oResGroup" value="ByResGroup" checked="checked" onclick="loadIngredientPicker()" />Resource Groups &nbsp;
        <input type="radio" name="oSelectType" id="oResType" value="ByResType" onclick="loadIngredientPicker()" />Resource Types
        <input type="radio" name="oSelectType" id="oComponent" value="ByComponent" onclick="loadIngredientPicker()" />Components
        </span>
		  </div>
      Filter:
      <select name="resGroupShortSel" id="resGroupShortSel" style="display:none;" onchange="setCookie('ingListResGroupShortSel',this.value,7);loadIngredientPicker();">
        {{ resourceGroupListShort }}
      </select>
      <select name="resGroupSel" id="resGroupSel" style="display:none;" onchange="setCookie('ingListResGroupSel',this.value,7);loadIngredientPicker();">
        {{ resourceGroupList }}
      </select>
      <select name="tabSel" id="tabSel" style="display:none;" onchange="setCookie('ingListTabSel',this.value,7);loadIngredientPicker();">
        {{ schematicTabList }}
      </select>
      <div id=busyImgList><img src="/images/ghWait.gif" alt="waiting..." border=0 /></div>
      <div id="ingredientPickerList"></div>
    </div>
  </div>
  <div id="rightMainContent" class="ghCol">
    <div class="ghWidgetBox">
			<div class="bigLink">Schematic: <input type="text" name="schematicName" value="{{ schematic.schematicName }}" size="60" maxlength="255" />
			{% if loggedin == 1 %}
					<div style="float:right;">
            <button type=button value="Cancel" class="ghButton" onclick="document.location.href='/schematics.py/{{ schematicID }}';">Cancel</button>
						<button type=button value="Save Schematic" class="ghButton" onclick="saveSchematic();">Save Schematic</button>
					</div>
			{% endif %}
      </div>
			<table width="100%">
				<tr>
					<td valign="top" width="360px"><h3>Ingredients</h3>
            <div id="schematicIngredients" onmousemove="slotHoverCheck(event)">
						<table id="ingredientTable">
					{% for ingredient in schematic.ingredients %}
							<tr class="ingredientRow" tt="{{ ingredient.objectName }}">
                <td><img src="/images/xRed16.png" alt="Remove Ingredient" title="Remove Ingredient" style="cursor:pointer;" onclick="$(this).parent().parent().remove();"/></td>
                <td><input type="text" name="ing_name_{{ ingredient.ingredientName }}" value="{{ ingredient.ingredientName }}"  /></td>
                <td style="padding-right:4px;"><input type="text" name="ing_qty_{{ ingredient.ingredientName }}" size="5" maxlength="7" value="{{ ingredient.ingredientQuantity }}" /></td>
                <td><img src="{{ ingredient.objectImage }}" class="schematicIngredient" /></td>
						  </tr>
					{% endfor %}
					  </table>
            </div>
					</td>

					<td valign="top"><h3>Qualities</h3><div>Quick Add: <select></select></div><ul id="qualitiesList" style="margin-top:6px;">
					{% for qualityGroup in schematic.qualityGroups %}
							<h4><input type="text" name="qg_{{ qualityGroup.groupName() }}" value="{{ qualityGroup.groupName() }}" /></h4>
							{% for expProp in qualityGroup.properties %}
									<li style="padding-left:10px;font-weight:bold;"><input type="text" name="sq_{{ expProp.propertyName() }}" value="{{ expProp.propertyName() }}" /></li>
									{% for statWeight in expProp.statWeights %}
											<li style="padding-left:20px;"><span class="inlineBlock" style="width:120px;">
                        <select class="statSelector" name="sw_{{ statWeight.qualityID }}_{{ statWeight.stat }}" tag="{{ statWeight.stat }}">{{ statList }}</select>: </span>
                        <span><input type="text" name="swp_{{ statWeight.statName() }}" size="2" maxlength="3" value="{{ statWeight.weightPercent() }}" />%</span>
                      </li>
									{% endfor %}
							{% endfor %}
					{% endfor %}
					</ul></td>

					<td valign="top" width="325px"><img src="/images/schematics/{{ schematic.schematicImage }}" class="schematics" />
					  <div id="udInfo">{{ schemImageAttempt }}</div>
				{% if loggedin == 1 %}
					  <form enctype="multipart/form-data" name="udImageForm" method="post" action="{{ BASE_SCRIPT_URL }}udSchematicImage.py">
					  <div class="inlineBlock" style="width:120px;font-weight:bold;">Add Image</div><div class="inlineBlock" style="text-align:right;">Use image from another schematic: <input type="checkbox" name="useExisting" id="useExisting" onclick="switchImageInput();" /></div>
					  <select id="copyFromSchem" name="copyFromSchem" style="display:none;"></select>
					  <input type="file" id="schemImage" name="schemImage" accept="image/gif, image/jpeg, image/png" />
					  <input type="hidden" name="schematicID" value="{{ schematicID }}" />
					  <input type="hidden" name="src_url" value="{{ BASE_SCRIPT_URL }}schematics.py" />
					  <input type="submit" value="Add" name="gosi" id="gosi" class="ghButton" />
					  </form>
            <div class="footer"></div>
            <table>
						  <tr><td>Profession: </td><td><select name="schemProfSel" id="schemProfSel" onchange="refreshSkillGroups()"><option value=0>Select Profession</option>
				      {{ professionList }}
              </select></td></tr>
						  <tr><td>Skill Group: </td><td><select name="skillGroupSel" id="skillGroupSel"></select></td></tr>
						  <tr><td>Crafting Tab: </td><td><select name="craftingTagSel" id="craftingTabSel">
              {{ schematicTabList }}
              </select></td></tr>
						  <tr><td>Object Type: </td><td><select name="objectTypeSel" id="objectTypeSel">
              {{ objectTypeList }}
              </select></td></tr>
						  <tr><td>XP: </td><td><input type="text" name="xpAmount" size="4" maxlength="5" value="{{ schematic.xpAmount }}" /></td></tr>
						  <tr><td>Complexity: </td><td><input type="text" name="complexity" size="4" maxlength="5" value="{{ schematic.complexity }}" /></td></tr>
            </table>
				{% endif %}
					</td>
			  </tr>
			</table>
	    <div class="footer" style="margin-top:12px;"></div>
    </div>
	</div>
</div>
{{ blocks.pageFooter() }}
{{ blocks.joinForm(loggedin, ['?src_url={{ BASE_SCRIPT_URL }}schematics.py&', linkappend]|join, url) }}
<div id="mask"></div>
<div id="tooltip"></div>
</body></html>
